{% extends "base.html" %}

{% block stylesheets %}
<style>
    /* Vue Cloak to hide raw variables before Vue loads */
    [v-cloak] { display: none; }

    /* Feed Layout */
    .feed-container {
        max-width: 800px;
        margin: 0 auto;
    }

    /* Post Creator */
    .post-creator {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        margin-bottom: 2rem;
    }

    .creator-textarea {
        border: none;
        resize: none;
        width: 100%;
        outline: none;
        font-size: 1rem;
        min-height: 80px;
        background: transparent;
    }

    .attachment-preview-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .preview-item {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eee;
    }

    .preview-item img, .preview-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(0,0,0,0.6);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }

    /* Post Card Styles */
    .post-card {
        background: white;
        border-radius: 16px;
        padding: 0;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        overflow: hidden;
    }

    .post-header {
        padding: 1.25rem 1.5rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .author-info {
        display: flex;
        gap: 12px;
    }

    .author-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
    }

    .author-meta h6 { margin: 0; font-weight: 600; font-size: 0.95rem; }
    .author-meta span { font-size: 0.75rem; color: var(--secondary-text); }
    .role-badge { 
        font-size: 0.65rem; 
        padding: 2px 6px; 
        border-radius: 4px; 
        background: #f3f4f6; 
        color: #666;
        margin-left: 6px;
    }

    .post-content {
        padding: 0.5rem 1.5rem;
        font-size: 0.95rem;
        white-space: pre-wrap;
        color: #1f2937;
    }

    /* Link Preview Card */
    .link-preview {
        margin: 0.5rem 1.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        background: #f9fafb;
        text-decoration: none;
        display: block;
    }
    .link-preview-img { width: 100%; height: 200px; object-fit: cover; }
    .link-meta { padding: 12px; }
    .link-title { font-weight: 600; color: #111; margin-bottom: 4px; font-size: 0.9rem;}
    .link-desc { font-size: 0.8rem; color: #6b7280; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* Media Grid for Posts */
    .media-grid {
        display: grid;
        gap: 2px;
        margin-top: 10px;
        background: #000;
    }
    .media-grid.cols-1 { grid-template-columns: 1fr; }
    .media-grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .media-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    
    .post-media-item {
        width: 100%;
        height: 300px; /* Fixed height for consistency */
        object-fit: cover;
        cursor: pointer;
    }

    .post-footer {
        padding: 0.8rem 1.5rem;
        border-top: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--secondary-text);
        font-size: 0.85rem;
    }

    .action-btn {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
    }
    .action-btn:hover { color: var(--active-color); }
    .action-btn.active { color: #ef4444; } /* Red for liked */

    .view-count { cursor: pointer; }
    .view-count:hover { text-decoration: underline; }

    /* Viewers Modal */
    .viewer-list-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f9fafb;
    }
    .viewer-list-item img { width: 32px; height: 32px; border-radius: 50%; }
</style>
{% endblock %}

{% block user_page %}
<div id="announcementApp" class="feed-container" v-cloak>
    
    <div class="post-creator">
        <textarea 
            v-model="newPost.content" 
            class="creator-textarea" 
            placeholder="Share an update with the team...">
        </textarea>
        
        <div class="attachment-preview-grid" v-if="newPost.tempFiles.length > 0">
            <div class="preview-item" v-for="(file, index) in newPost.tempFiles" :key="index">
                <img v-if="file.type.startsWith('image')" :src="file.preview" />
                <video v-else-if="file.type.startsWith('video')" :src="file.preview"></video>
                <div v-else class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                    <i class="ri-file-text-line"></i>
                </div>
                <div class="remove-btn" @click="removeFile(index)"><i class="ri-close-line"></i></div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
            <div class="d-flex gap-3">
                <button class="btn btn-light btn-sm rounded-pill text-secondary" @click="$refs.fileInput.click()">
                    <i class="ri-image-add-line text-success me-1"></i> Photo/Video
                </button>
                <button class="btn btn-light btn-sm rounded-pill text-secondary" @click="$refs.docInput.click()">
                    <i class="ri-file-add-line text-primary me-1"></i> Document
                </button>
            </div>
            
            <button class="btn btn-warning text-white px-4 rounded-pill" 
                    :disabled="isPosting || (!newPost.content && newPost.tempFiles.length === 0)"
                    @click="publishPost">
                <span v-if="isPosting" class="spinner-border spinner-border-sm me-2"></span>
                [[ isPosting ? 'Posting...' : 'Post' ]]
            </button>
        </div>

        <input type="file" ref="fileInput" multiple accept="image/*,video/*" class="d-none" @change="handleFileSelect">
        <input type="file" ref="docInput" multiple accept=".pdf,.doc,.docx" class="d-none" @change="handleFileSelect">
    </div>

    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-warning" role="status"></div>
    </div>

    <div v-else-if="posts.length === 0" class="text-center py-5 text-muted">
        <i class="ri-megaphone-line fs-1 mb-2"></i>
        <p>No announcements yet.</p>
    </div>

    <div v-else class="post-stream">
        <div class="post-card" v-for="post in posts" :key="post.id">
            
            <div class="post-header">
                <div class="author-info">
                    <img :src="post.author.profile_picture_url || 'https://ui-avatars.com/api/?name='+post.author.full_name" class="author-avatar">
                    <div class="author-meta">
                        <h6>[[ post.author.full_name ]] <span class="role-badge">[[ post.author.role ]]</span></h6>
                        <span>[[ formatDate(post.created_at) ]]</span>
                    </div>
                </div>
                
                <div class="dropdown" v-if="canDelete(post.author.id)">
                    <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown">
                        <i class="ri-more-line fs-5"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                        <li><a class="dropdown-item text-danger" href="#" @click.prevent="deletePost(post.id)"><i class="ri-delete-bin-line me-2"></i>Delete Post</a></li>
                    </ul>
                </div>
            </div>

            <div class="post-content" v-if="post.content">
                [[ post.content ]]
            </div>

            <a v-if="post.link_url && post.link_title" :href="post.link_url" target="_blank" class="link-preview">
                <img v-if="post.link_image" :src="post.link_image" class="link-preview-img">
                <div class="link-meta">
                    <div class="link-title">[[ post.link_title ]]</div>
                    <div class="link-desc">[[ post.link_description ]]</div>
                </div>
            </a>

            <div v-if="post.attachments.length > 0" class="media-grid" :class="'cols-' + Math.min(post.attachments.length, 3)">
                <div v-for="att in post.attachments" :key="att.id">
                    <img v-if="att.file_type === 'image'" :src="att.file_url" class="post-media-item">
                    <video v-else-if="att.file_type === 'video'" :src="att.file_url" controls class="post-media-item"></video>
                    <div v-else class="p-3 bg-light border m-2 rounded d-flex align-items-center">
                        <i class="ri-file-text-fill fs-3 me-2 text-primary"></i>
                        <a :href="att.file_url" target="_blank" class="text-dark text-decoration-none">Download Document</a>
                    </div>
                </div>
            </div>

            <div class="post-footer">
                <div class="d-flex gap-4">
                    <div class="action-btn" :class="{ 'active': userHasReacted(post) }" @click="toggleReaction(post)">
                        <i :class="userHasReacted(post) ? 'ri-heart-fill' : 'ri-heart-line'"></i>
                        <span>[[ post.reactions.length || 0 ]]</span>
                    </div>
                    <div class="view-count" @click="openViewersModal(post.id)">
                        <i class="ri-eye-line me-1"></i> [[ post.view_count ]] Seen
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewersModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h6 class="modal-title fw-bold">Seen By</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div v-if="currentViewers.length === 0" class="text-muted small">No views yet.</div>
                    <div v-for="viewer in currentViewers" :key="viewer.user_id" class="viewer-list-item">
                        <img :src="viewer.user.profile_picture_url || 'https://ui-avatars.com/api/?name='+viewer.user.full_name">
                        <div class="small fw-medium">[[ viewer.user.full_name ]]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block javascript %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="{{ url_for('static', path='/js/announcement/admin_feed.js') }}"></script>
{% endblock %}