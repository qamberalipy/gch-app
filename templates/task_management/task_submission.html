{% extends "base.html" %}

{% block stylesheets %}
<style>
    /* --- GRAIL THEME PALETTE --- */
    :root {
        --grail-gold: #C89E47;
        --grail-gold-hover: #b08a3d;
        --grail-dark: #1F2937;
        --grail-light: #F9FAFB;
        --grail-border: #E5E7EB;
        --status-missed: #ef4444; 
        --status-done: #10b981;   
        --status-todo: #f59e0b;   
        --status-blocked: #6b7280;
    }

    /* --- PAGE HEADER --- */
    .dashboard-header {
        background: linear-gradient(135deg, #FFFDF5 0%, #FFFFFF 100%);
        border-bottom: 1px solid var(--grail-border);
        padding: 25px 20px;
        border-radius: 12px 12px 0 0;
    }
    .page-title { font-size: 1.5rem; font-weight: 700; color: var(--grail-dark); letter-spacing: -0.5px; }
    .page-subtitle { color: #6B7280; font-size: 0.9rem; margin-top: 4px; }

    /* --- MODERN INPUTS --- */
    .grail-input {
        background-color: #F8FAFC; border: 1px solid #E2E8F0;
        border-radius: 12px; padding: 10px 15px; font-size: 0.9rem;
        color: #1E293B; font-weight: 500; transition: all 0.2s ease;
        box-shadow: none; height: 45px;
    }
    .grail-input:hover { background-color: #fff; border-color: #CBD5E1; }
    .grail-input:focus { background-color: #fff; border-color: var(--grail-gold); box-shadow: 0 0 0 3px rgba(200, 158, 71, 0.15); outline: none; }
    
    select.grail-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat; background-position: right 15px center; background-size: 12px 12px; cursor: pointer;
    }
    .grail-input::placeholder { color: #94A3B8; font-weight: 400; }

    /* --- CARDS --- */
    .grail-card {
        background: #fff; border: 1px solid var(--grail-border); border-radius: 16px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden; height: 100%; display: flex; flex-direction: column;
        cursor: pointer; position: relative;
    }
    .grail-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
    
    /* Status Borders */
    .grail-card.c-todo { border-left: 4px solid var(--status-todo); }
    .grail-card.c-completed { border-left: 4px solid var(--status-done); opacity: 0.85; }
    .grail-card.c-missed { border-left: 4px solid var(--status-missed); background: #FFFBFB; }
    .grail-card.c-blocked { border-left: 4px solid var(--status-blocked); }

    .card-top { padding: 20px 20px 15px; flex-grow: 1; }
    .task-meta { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #9CA3AF; letter-spacing: 0.5px; }
    .task-title { font-size: 1.1rem; font-weight: 700; color: var(--grail-dark); margin: 0 0 8px; line-height: 1.35; }
    .task-desc { font-size: 0.85rem; color: #6B7280; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 15px; }

    .card-btm { padding: 12px 20px; border-top: 1px solid #f3f4f6; background: #FDFDFD; display: flex; justify-content: space-between; align-items: center; }
    
    /* Pagination */
    .pagination-btn {
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; border: 1px solid #E5E7EB; background: white; color: #6B7280;
        cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
    }
    .pagination-btn:hover:not(:disabled) { border-color: var(--grail-gold); color: var(--grail-gold); background: #FFFBF0; }
    .pagination-btn:disabled { background: #F3F4F6; color: #D1D5DB; cursor: not-allowed; border-color: #F3F4F6; }

    /* Badges */
    .badge-status { padding: 5px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.3px; }
    .badge-todo { background: #FEF3C7; color: #92400E; }
    .badge-completed { background: #D1FAE5; color: #059669; }
    .badge-blocked { background: #F3F4F6; color: #4B5563; }
    .badge-missed { background: #FEE2E2; color: #991B1B; }

    /* Modal Tweaks */
    .modal-content { border-radius: 16px; overflow: hidden; border: none; }
    .submission-zone { border: 2px dashed var(--grail-border); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: #fff; }
    .submission-zone:hover { border-color: var(--grail-gold); background: #FFFCF5; }
    .btn-grail-gold { background-color: var(--grail-gold); border-color: var(--grail-gold); color: white; }
    .btn-grail-gold:hover { background-color: var(--grail-gold-hover); border-color: var(--grail-gold-hover); color: white; }
    
    .desc-clamp { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .desc-expand-btn { font-size: 0.8rem; color: var(--grail-gold); cursor: pointer; font-weight: 600; text-decoration: none; }

</style>
{% endblock stylesheets %}

{% block user_page %}
<div class="main-div">
    
    <div class="dashboard-header">
        <h2 class="page-title mb-0">My Assignments</h2>
        <p class="page-subtitle mb-0">Track deadlines, upload content, and manage your workflow.</p>
    </div>

    <div class="grail-table-card pt-0 border-top-0 rounded-top-0" style="min-height: auto; border-radius: 0 0 12px 12px;">
        <div class="d-flex flex-wrap gap-3 p-3 align-items-center">
            
            <div class="position-relative flex-grow-1" style="min-width: 250px;">
                <i class="ri-search-2-line position-absolute text-muted" style="top: 50%; left: 15px; transform: translateY(-50%); font-size: 1.1rem;"></i>
                <input type="text" class="form-control grail-input ps-5" id="filterSearch" placeholder="Search tasks...">
            </div>

            <div class="d-none d-md-block border-end mx-1" style="height: 25px;"></div>

            <div class="position-relative" style="min-width: 180px;">
                <i class="ri-filter-3-line position-absolute text-muted" style="top: 50%; left: 15px; transform: translateY(-50%);"></i>
                <select class="form-select grail-input ps-5" id="filterStatus">
                    <option value="">All Statuses</option>
                    <option value="To Do">To Do</option>
                    <option value="Completed">Completed</option>
                    <option value="Blocked">Blocked</option>
                    <option value="Missed">Missed</option>
                </select>
            </div>

            <button class="btn btn-light rounded-circle border d-flex align-items-center justify-content-center" 
                    style="width: 42px; height: 42px;" 
                    title="Refresh" onclick="loadMyTasks()">
                <i class="ri-refresh-line text-muted"></i>
            </button>
        </div>
    </div>

    <div class="row g-4 px-3 py-4" id="taskGrid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-warning"></div>
        </div>
    </div>

    <div class="px-3 pb-4">
        <div class="d-flex justify-content-between align-items-center bg-white border p-3 rounded-3 shadow-sm">
            <span class="text-muted small" id="paginationInfo">Showing 0-0 of 0</span>
            <div class="d-flex gap-2">
                <button class="pagination-btn" id="btnPrevPage" disabled><i class="ri-arrow-left-s-line"></i></button>
                <button class="pagination-btn" id="btnNextPage" disabled><i class="ri-arrow-right-s-line"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="submissionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-0">
                <div class="row g-0 h-100">
                    <div class="col-lg-4 p-4 bg-light border-end overflow-auto">
                        <h5 class="fw-bold mb-3" id="modalTitle">Task Title</h5>
                        
                        <div class="mb-4">
                            <span class="text-uppercase text-muted fw-bold small d-block mb-1">Description</span>
                            <div class="text-muted small" id="descContainer">
                                <p id="modalDesc" class="mb-1 desc-clamp" style="white-space: pre-line;">-</p>
                                <a id="toggleDescBtn" class="desc-expand-btn d-none" onclick="toggleDescription()">Read More</a>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <span class="text-uppercase text-muted fw-bold small d-block mb-1">Quantity</span>
                                <div class="fw-bold" id="modalQty">-</div>
                            </div>
                            <div class="col-6">
                                <span class="text-uppercase text-muted fw-bold small d-block mb-1">Duration</span>
                                <div class="fw-bold" id="modalDuration">-</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <span class="text-uppercase text-muted fw-bold small d-block mb-2">Requirements</span>
                            <div class="d-flex gap-2">
                                <div class="badge bg-white border text-secondary fw-normal p-2" id="modalFace"></div>
                                <div class="badge bg-white border text-secondary fw-normal p-2" id="modalWatermark"></div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <span class="text-uppercase text-muted fw-bold small d-block mb-2">Theme / Tags</span>
                            <div id="modalTags" class="d-flex flex-wrap gap-1"></div>
                        </div>

                        <div class="mt-auto">
                            <span class="text-uppercase text-muted fw-bold small d-block mb-2"><i class="ri-attachment-line"></i> Reference Files</span>
                            <div id="modalReferences" class="mt-2"></div>
                        </div>
                    </div>

                    <div class="col-lg-8 p-4 bg-white d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="fw-bold m-0 text-dark">Submission Area</h5>
                                <span class="text-muted small">Upload your final deliverables</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-dark btn-sm rounded-pill px-3" id="btnOpenChat">
                                    <i class="ri-chat-1-line me-1"></i> Chat
                                </button>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                        </div>

                        <div class="alert alert-light border d-flex align-items-center mb-3 p-2 rounded-3" id="statusAlert"></div>

                        <div class="submission-zone mb-3" id="dropZone">
                            <i class="ri-upload-cloud-2-fill fs-1 text-warning mb-2" style="color: var(--grail-gold)!important;"></i>
                            <h6 class="fw-bold text-dark">Upload Deliverables</h6>
                            <p class="text-muted small mb-0">Drag & drop or click to browse</p>
                            <input type="file" id="fileInput" multiple hidden>
                        </div>

                        <div class="flex-grow-1 mb-3 bg-light rounded-3 p-3 border overflow-auto" style="max-height: 300px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold small text-dark">Your Files</span>
                                <span class="badge bg-white border text-muted" id="fileCount">0 Files</span>
                            </div>
                            <div id="deliverablesList"></div>
                        </div>

                        <div class="d-grid mt-auto">
                            <button class="btn btn-grail-gold py-2 rounded-pill fw-bold shadow-sm" id="btnSubmitWork">
                                <i class="ri-check-double-line me-1"></i> Submit Work
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="chatModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header bg-white border-bottom p-3">
                <h6 class="mb-0 fw-bold">Task Chat</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="bg-light p-0" style="height: 400px;">
                <div class="h-100 p-3 overflow-auto" id="chatContainer"></div>
            </div>
            <div class="p-3 bg-white border-top">
                <form id="chatForm" class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control rounded-pill border-0 bg-light py-2 px-3 shadow-none" 
                           id="chatInput" placeholder="Type a message..." required autocomplete="off">
                    <button type="submit" class="btn btn-grail-gold rounded-circle shadow-sm" 
                            id="btnSendChat" style="width: 40px; height: 40px; padding: 0;">
                        <i class="ri-send-plane-fill"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="{{ url_for('static', path='/js/task_management/task_submission.js') }}"></script>
{% endblock %}